name: MoneyPrinter Deploy (New)

on:
  push:
    paths:
      - 'strategy/**'
      - 'jobs/**'
      - 'training_bundle/**'
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Databricks CLI
        run: |
          pip install databricks-cli
          # Suppress API 2.0 warnings
          databricks jobs configure --version=2.1

      - name: Debug Environment
        run: |
          echo "Checking Secrets..."
          if [ -z "$DATABRICKS_HOST" ]; then echo "❌ DATABRICKS_HOST is missing!"; else echo "✅ DATABRICKS_HOST is set"; fi
          if [ -z "$DATABRICKS_TOKEN" ]; then echo "❌ DATABRICKS_TOKEN is missing!"; else echo "✅ DATABRICKS_TOKEN is set"; fi

      - name: Deploy and Run Job
        run: |
          JOB_NAME="MoneyPrinter_Production_Train"
          CONFIG_FILE="jobs/job_config.json"
          
          echo "Checking for existing job: $JOB_NAME"
          
          # Filter out WARN logs from databricks-cli output
          EXISTING_JOB_ID=$(databricks jobs list --output json | grep -v "WARN" | jq -r ".jobs[] | select(.settings.name == \"$JOB_NAME\") | .job_id")
          
          if [ -n "$EXISTING_JOB_ID" ] && [ "$EXISTING_JOB_ID" != "null" ]; then
            echo "Found existing job ID: $EXISTING_JOB_ID. Resetting configuration..."
            databricks jobs reset --job-id "$EXISTING_JOB_ID" --json-file "$CONFIG_FILE"
            JOB_ID=$EXISTING_JOB_ID
          else
            echo "Job not found. Creating new job..."
            # Create returns: { "job_id": 123 }
            # Only keep the JSON part (ignore warnings)
            JOB_ID=$(databricks jobs create --json-file "$CONFIG_FILE" | grep -v "WARN" | jq -r '.job_id')
            echo "Created new job ID: $JOB_ID"
          fi
          
          echo "Triggering Run for Job ID: $JOB_ID"
          run_id=$(databricks jobs run-now --job-id "$JOB_ID" --output json | grep -v "WARN" | jq -r '.run_id')
          echo "Run ID: $run_id"
          echo "Track run at: $DATABRICKS_HOST/?o=0#job/$JOB_ID/run/$run_id"
